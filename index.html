<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Streamer QR Code</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            margin: 50px auto;
        }
        h1 { 
            color: #333; 
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .qr-code { 
            margin: 20px 0; 
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .qr-code img {
            max-width: 300px;
            height: auto;
        }
        .info { 
            background: #e8f4f8; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .status { 
            color: #666; 
            font-size: 14px; 
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .instructions {
            text-align: left;
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        .instructions h3 {
            margin-top: 0;
            color: #856404;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 5px 0;
            color: #856404;
        }
        code {
            background: #f1f1f1;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .manual-entry {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #17a2b8;
        }
        .manual-entry h3 {
            margin-top: 0;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Audio Streamer</h1>
        <p class="subtitle">Connect your iPhone to stream Mac audio</p>
        
        <div class="qr-code">
            <img id="qrCode" src="" alt="QR Code" style="max-width: 300px;">
        </div>
        
        <div class="info">
            <strong>Connection Details:</strong><br>
            IP Address: <code id="ipAddress">Loading...</code><br>
            Port: <code>3001</code>
        </div>
        
        <div class="manual-entry">
            <h3>üìù Manual Entry (Alternative):</h3>
            <p>If QR code scanning doesn't work, you can manually enter:</p>
            <p><strong>IP:</strong> <span id="manualIP">Loading...</span><br>
            <strong>Port:</strong> 3001</p>
        </div>
        
        <div class="instructions">
            <h3>üîß Quick Setup:</h3>
            <ol>
                <li>Clone this repository: <code>git clone https://github.com/hatinshemet/mac-audio-streamer.git</code></li>
                <li>Run setup: <code>cd mac-audio-streamer && ./setup.sh</code></li>
                <li>Start server: <code>./start-server.sh</code></li>
                <li>Use the IP address shown by the server</li>
            </ol>
        </div>
        
        <div class="instructions">
            <h3>üì± How to Connect:</h3>
            <ol>
                <li>Open your AudioReceiver app on iPhone</li>
                <li>Tap "Scan QR Code" and scan the code above</li>
                <li>OR manually enter the IP and port above</li>
                <li>Tap "Start Receiving" to begin streaming</li>
            </ol>
        </div>
        
        <div class="status">
            <strong>Status:</strong> Ready to connect<br>
            <strong>Note:</strong> Make sure your Mac's UDP server is running on port 3001
        </div>
    </div>

    <script>
        // Function to get the user's local IP address
        async function getUserIP() {
            try {
                // Try to get IP from a public service
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                // Fallback: try to detect local IP
                return new Promise((resolve) => {
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    });
                    
                    pc.createDataChannel('');
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));
                    
                    pc.onicecandidate = (ice) => {
                        if (ice && ice.candidate && ice.candidate.candidate) {
                            const candidate = ice.candidate.candidate;
                            const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
                            if (ipMatch) {
                                pc.close();
                                resolve(ipMatch[1]);
                            }
                        }
                    };
                    
                    // Timeout fallback
                    setTimeout(() => {
                        pc.close();
                        resolve('192.168.1.100'); // Default fallback
                    }, 3000);
                });
            }
        }

        // Function to generate QR code
        function generateQRCode(ip) {
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${ip}:3001&v=${Date.now()}`;
            document.getElementById('qrCode').src = qrCodeUrl;
            document.getElementById('ipAddress').textContent = ip;
            document.getElementById('manualIP').textContent = ip;
        }

        // Initialize when page loads
        window.addEventListener('load', async () => {
            try {
                const ip = await getUserIP();
                generateQRCode(ip);
            } catch (error) {
                console.error('Error getting IP:', error);
                // Fallback to a generic message
                document.getElementById('ipAddress').textContent = 'Unable to detect IP';
                document.getElementById('manualIP').textContent = 'Check your local network IP';
                document.getElementById('qrCode').src = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=YOUR_IP:3001';
            }
        });
    </script>
</body>
</html>